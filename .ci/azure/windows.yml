steps:
- pwsh: |
    Get-CimInstance Win32_Processor | Select-Object -Property [a-z]*
    Get-CimInstance Win32_OperatingSystem | Select-Object -Property [a-z]*
    Get-CimInstance Win32_LogicalDisk
  displayName: Dump VM specs

- script: set
  displayName: Dump environment variables

# We will install the latest version later on.
- pwsh: |
    $products = Get-CimInstance -ClassName Win32_Product -Filter "Name like 'Microsoft MPI%'"
    foreach ($p in $products) {
      echo "Uninstalling $($p.Name)"
      Invoke-CimMethod -InputObject $p -MethodName Uninstall
    }
  condition: and(succeeded(), startsWith(variables.MODE, 'dm'))
  displayName: Remove existing MSMPI

- script: |
    choco install msys2 --params "/InstallDir:c:\msys64"
  displayName: Install MSYS2

- task: BatchScript@1
  displayName: Setup dependencies
  inputs:
    filename: .ci\appveyor\setup-dependencies.bat
    modifyEnvironment: true

- script: call .ci\appveyor\install-wrf.bat
  displayName: Install WRF

# In Azure Pipeline builds, the repository folder is not named after the repository name.
# To avoid having to pass a different folder to the CMake config in install-wps.bat,
# we symlink the repository to the "WRF" folder.
- script: mklink /J ..\WRF .
  displayName: Symlink repository as "WRF" for convenience

- script: |
    pushd ..
    git clone --depth=100 --no-single-branch https://github.com/%WPS_REPO%.git WPS
    cd WPS
    git checkout %WPS_COMMIT%
    call .ci\appveyor\install-wps.bat
  displayName: Install WPS

- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.x'

- script: |
    git clone --depth=1 --branch=%WATS_BRANCH% https://github.com/%WATS_REPO%.git wats
    pip install -r wats/requirements.txt
  displayName: Install WATS

- pwsh: |
    if ($Env:MODE.StartsWith("dm")) { $mpi_flag="--mpi" }
    if ($Env:BUILD_SYSTEM -eq "cmake") { $dir_suffix="build/install" }
    python wats/wats/main.py run --mode $Env:WATS_MODE --wrf-dir ./$dir_suffix --wps-dir ../WPS/$dir_suffix --work-dir wats_work $mpi_flag
  displayName: Run WATS

#- task: PublishPipelineArtifact@0
#  displayName: Publish binaries
#  inputs:
#    artifactName: binaries_$(OS_NAME)_$(BUILD_SYSTEM)_$(BUILD_TYPE)_$(MODE)
#    targetPath: build/install/main
