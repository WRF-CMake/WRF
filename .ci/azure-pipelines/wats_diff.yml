jobs:
- job: wats_diff_${{ parameters.OS_NAME_CMAKE }}_${{ parameters.BUILD_TYPE }}_${{ parameters.MODE }}
  displayName: 'WATS ${{ parameters.OS_NAME_CMAKE }}: ${{ parameters.BUILD_TYPE }}, ${{ parameters.MODE }}'
  
  pool:
    vmImage: ubuntu-16.04
  
  dependsOn:
  - ${{ parameters.OS_NAME_MAKE }}_Make_${{ parameters.BUILD_TYPE }}_${{ parameters.MODE }}
  - ${{ parameters.OS_NAME_CMAKE }}_CMake_${{ parameters.BUILD_TYPE }}_${{ parameters.MODE }}
  
  steps:
  - checkout: none
  
  - task: DownloadBuildArtifacts@0
    displayName: Retrieve Make WATS outputs
    inputs:
      downloadPath: wats_outputs
      downloadType: specific
      itemPattern: 'wats_${{ parameters.OS_NAME_MAKE }}_Make_${{ parameters.BUILD_TYPE }}_${{ parameters.MODE }}/**'
  
  - task: DownloadBuildArtifacts@0
    displayName: Retrieve CMake WATS outputs
    inputs:
      downloadPath: wats_outputs
      downloadType: specific
      itemPattern: 'wats_${{ parameters.OS_NAME_CMAKE }}_CMake_${{ parameters.BUILD_TYPE }}_${{ parameters.MODE }}/**'
  
  - script: |
      cd wats_outputs
      find . -type f
    displayName: List WATS output files
  
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.x'
  
  - script: |
      git clone --depth=1 --branch=$WATS_BRANCH https://github.com/$WATS_REPO.git wats
      pip install -r wats/requirements.txt
    displayName: Install WATS
  
  - script: |
      set -ex
      O=wats_outputs
      W="python wats/wats/main.py diff --mode $WATS_MODE"
      $W $O/wats_${{ parameters.OS_NAME_MAKE }}_Make_${{ parameters.BUILD_TYPE }}_${{ parameters.MODE }} $O/wats_${{ parameters.OS_NAME_CMAKE }}_CMake_${{ parameters.BUILD_TYPE }}_${{ parameters.MODE }}
    displayName: Run WATS diff
      